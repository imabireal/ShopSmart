<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopSmart - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-gray-800 text-white p-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Welcome to ShopSmart</h1>
            <nav class="flex items-center space-x-4">
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('cart') }}" class="relative bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition duration-200">
                    Cart
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center {% if not cart_count or cart_count == 0 %}hidden{% endif %}">{{ cart_count or 0 }}</span>
                </a>
                <a href="{{ url_for('logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition duration-200">Logout</a>
                {% else %}
                <a href="{{ url_for('login') }}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition duration-200">Login</a>
                <a href="{{ url_for('register') }}" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition duration-200">Register</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-8 space-y-8">
        <section id="products">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Products</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for product in products %}
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 p-6 border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">{{ product.name }}</h3>
                    <p class="text-green-600 font-bold text-lg mb-4">${{ product.price }}</p>
                    {% if current_user.is_authenticated %}
                    <button class="add-to-cart w-half bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 transform hover:scale-105" 
                            data-product-id="{{ product.id }}" 
                            data-product-name="{{ product.name }}">
                        Add to Cart
                    </button>
                    <button class="buy-now w-half bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 transform hover:scale-105" 
                            data-product-id="{{ product.id }}" 
                            data-product-name="{{ product.name }}">
                        Buy Now
                    </button>
                    {% else %}
                    <button class="login-required w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 cursor-not-allowed" 
                            data-product-name="{{ product.name }}">
                        Login to Add to Cart
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="space-y-2">
                    {% for category, message in messages %}
                        <div class="p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
    </main>

    <script>
        // Add to Cart and Login functionality
        document.addEventListener('DOMContentLoaded', function() {
            const addToCartButtons = document.querySelectorAll('.add-to-cart');
            const buyNowButtons = document.querySelectorAll('.buy-now');
            const loginRequiredButtons = document.querySelectorAll('.login-required');
            
            // Handle add to cart for authenticated users
            addToCartButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const productName = this.getAttribute('data-product-name');
                    
                    // Disable button temporarily
                    this.disabled = true;
                    this.textContent = 'Adding...';
                    
                    fetch(`/add_to_cart/${productId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update cart count in header
                                const cartCount = document.getElementById('cart-count');
                                if (cartCount) {
                                    cartCount.textContent = data.cart_count;
                                    cartCount.style.display = data.cart_count > 0 ? 'flex' : 'none';
                                }
                                
                                // Show success message
                                this.textContent = 'Added!';
                                this.classList.add('bg-blue-500');
                                this.classList.remove('bg-green-500');
                                
                                setTimeout(() => {
                                    this.textContent = 'Add to Cart';
                                    this.classList.remove('bg-blue-500');
                                    this.classList.add('bg-green-500');
                                    this.disabled = false;
                                }, 1000);
                            } else {
                                // Handle authentication error
                                if (data.redirect) {
                                    if (confirm(data.message + '. Would you like to log in now?')) {
                                        window.location.href = data.redirect;
                                    }
                                } else {
                                    alert('Error: ' + data.message);
                                }
                                this.disabled = false;
                                this.textContent = 'Add to Cart';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred. Please try again.');
                            this.disabled = false;
                            this.textContent = 'Add to Cart';
                        });
                });
            });
            
            // Handle buy now for authenticated users
            buyNowButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const productName = this.getAttribute('data-product-name');
                    
                    // Disable button temporarily
                    this.disabled = true;
                    this.textContent = 'Processing...';
                    
                    // Redirect directly to buy now route (now goes to immediate checkout)
                    window.location.href = `/buy_now/${productId}`;
                });
            });
            
            // Handle login requirement for non-authenticated users
            loginRequiredButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const productName = this.getAttribute('data-product-name');
                    if (confirm(`Please log in to add "${productName}" to your cart. Would you like to log in now?`)) {
                        window.location.href = '/login';
                    }
                });
            });
        });
    </script>
</body>
</html>
